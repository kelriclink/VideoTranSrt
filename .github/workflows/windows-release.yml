name: Build Windows EXE and Release

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller pyinstaller-hooks-contrib

      - name: Build EXE (PyInstaller one-folder, include plugins)
        shell: pwsh
        run: |
          # 生成可执行文件（文件夹形式，包含所有依赖）
          # 入口脚本切换为 GUI：video2srt/gui/main.py；图标位于 video2srt/gui/icon.ico
          pyinstaller --noconfirm --clean `
            --name Video2SRT `
            --icon video2srt/gui/icon.ico `
            --onedir `
            --windowed `
            --add-data "config/default_config.json;config" `
            --add-data "video2srt/plugins;video2srt/plugins" `
            --collect-submodules video2srt `
            --collect-submodules video2srt.plugins `
            --collect-submodules whisper `
            --collect-submodules torch `
            --collect-submodules PyQt6 `
            --collect-submodules yaml `
            --hidden-import yaml `
            --hidden-import yaml._yaml `
            video2srt/gui/main.py

      - name: Download FFmpeg and copy to dist
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          $ffmpegUrl = "https://www.gyan.dev/ffmpeg/builds/ffmpeg-release-essentials.zip"
          $zipPath = "ffmpeg.zip"
          Write-Host "Downloading FFmpeg from $ffmpegUrl"
          Invoke-WebRequest -Uri $ffmpegUrl -OutFile $zipPath
          Expand-Archive -Path $zipPath -DestinationPath "ffmpeg" -Force
          $ffmpegExe = Get-ChildItem -Recurse -File ffmpeg | Where-Object { $_.Name -eq "ffmpeg.exe" } | Select-Object -First 1
          $ffprobeExe = Get-ChildItem -Recurse -File ffmpeg | Where-Object { $_.Name -eq "ffprobe.exe" } | Select-Object -First 1
          if (-not $ffmpegExe) { throw "ffmpeg.exe not found in extracted archive" }
          New-Item -ItemType Directory -Force -Path "dist\Video2SRT" | Out-Null
          Copy-Item $ffmpegExe.FullName -Destination "dist\Video2SRT\"
          if ($ffprobeExe) { Copy-Item $ffprobeExe.FullName -Destination "dist\Video2SRT\" }

      - name: List build outputs
        shell: pwsh
        run: |
          Get-ChildItem -Recurse dist\Video2SRT | Format-List

      # 移除手动压缩步骤，避免双层压缩；Artifacts 自带单层压缩

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: Video2SRT-windows
          path: |
            dist/Video2SRT/

  release:
    name: Create GitHub Release v0.6
    needs: build-windows
    runs-on: windows-latest
    permissions:
      contents: write
    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: Video2SRT-windows
          path: artifact

      - name: Zip folder for release (single compression)
        shell: pwsh
        run: |
          $dest = "artifact/Video2SRT-v0.6-windows.zip"
          if (Test-Path $dest) { Remove-Item $dest -Force }
          Compress-Archive -Path artifact/Video2SRT/* -DestinationPath $dest
          Write-Host "Created $dest"

      - name: Create or update tag v0.6
        uses: actions/github-script@v7
        with:
          script: |
            const tag = 'v0.6';
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            // Use the commit SHA of this workflow run
            const sha = context.sha;
            try {
              // Try to get the tag
              const { data: tagRef } = await github.rest.git.getRef({ owner, repo, ref: `tags/${tag}` });
              // Update existing tag to current sha
              await github.rest.git.updateRef({ owner, repo, ref: `tags/${tag}`, sha, force: true });
              core.info(`Updated tag ${tag} to ${sha}`);
            } catch (e) {
              // Create tag if it doesn't exist
              await github.rest.git.createRef({ owner, repo, ref: `refs/tags/${tag}`, sha });
              core.info(`Created tag ${tag} at ${sha}`);
            }

      - name: Publish GitHub Release v0.6
        uses: ncipollo/release-action@v1
        with:
          tag: v0.6
          name: "Video2SRT v0.6"
          artifacts: artifact/Video2SRT-v0.6-windows.zip
          allowUpdates: true
          replacesArtifacts: true
          token: ${{ github.token }}